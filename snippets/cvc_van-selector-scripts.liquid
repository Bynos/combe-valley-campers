{% comment %}
  CVC Van Selector - Complete Implementation
  This file includes all CSS and JavaScript needed for the van selector system
  Add this to your theme.liquid or header section
{% endcomment %}

<style>
/**
 * CVC Van Selector Styles
 */

/* Van Selector Dropdown */
.van-selector {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem;
  background: #f9f9f9;
  border-radius: 6px;
}

.van-selector__label {
  font-weight: 600;
  white-space: nowrap;
  font-size: 0.95rem;
}

.van-selector__dropdown {
  flex: 1;
  max-width: 300px;
  padding: 0.5rem;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 1rem;
  background: white;
  cursor: pointer;
}

.van-selector__dropdown:focus {
  outline: 2px solid #0066cc;
  outline-offset: 2px;
}

.van-selector__clear {
  padding: 0.5rem 1rem;
  background: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.9rem;
  transition: background 0.2s;
  white-space: nowrap;
}

.van-selector__clear:hover {
  background: #e0e0e0;
}

/* Megamenu Base Styles */
.cvc-megamenu {
  width: 100%;
  padding: 2rem;
  background: white;
}

.cvc-megamenu__container {
  max-width: 1200px;
  margin: 0 auto;
}

.cvc-megamenu__title {
  font-size: 2rem;
  font-weight: 700;
  margin-bottom: 2rem;
  text-align: center;
  color: #222;
}

/* Van Model Megamenu */
.cvc-megamenu--van-models {
  min-height: 500px;
}

.cvc-megamenu__content--two-column {
  display: grid;
  grid-template-columns: 1fr 2fr;
  gap: 3rem;
  align-items: start;
}

.cvc-megamenu__images {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
  gap: 1rem;
}

.cvc-van-model-link--image {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-decoration: none;
  padding: 0;
  border: none;
  transition: all 0.3s ease;
}

.cvc-van-model-link--image:hover {
  border-color: #0066cc;
  background: #f5f5f5;
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.cvc-van-model-link--image.active {
  border-color: #0066cc;
  background: #e6f2ff;
}

.cvc-van-model-link--image img {
  width: 100%;
  height: auto;
  object-fit: contain;
  margin-bottom: 0.5rem;
  border-radius: 4px;
}

.cvc-van-model-link__placeholder {
  width: 100%;
  aspect-ratio: 4/3;
  background: #e0e0e0;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
  margin-bottom: 0.5rem;
}

.cvc-van-model-link__placeholder span {
  font-size: 0.85rem;
  color: #666;
  text-align: center;
  padding: 0.5rem;
}

.cvc-van-model-link__label {
  font-size: 0.9rem;
  font-weight: 600;
  text-align: center;
  color: #333;
}

.cvc-megamenu__text-links {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 0.5rem;
  align-content: start;
}

.cvc-van-model-link--text {
  display: block;
  padding: 0.75rem 1rem;
  text-decoration: none;
  color: #333;
  border-radius: 4px;
  transition: all 0.2s ease;
  font-weight: 500;
  border: 1px solid transparent;
}

.cvc-van-model-link--text:hover {
  background: #f5f5f5;
  border-color: #ddd;
}

.cvc-van-model-link--text.active {
  background: #e6f2ff;
  color: #0066cc;
  font-weight: 600;
  border-color: #0066cc;
}

/* Conversion Guides Megamenu */
.cvc-megamenu--conversion-guides {
  min-height: 400px;
}

.cvc-megamenu__phases {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 2rem;
}

.cvc-phase-column {
  display: flex;
  flex-direction: column;
}

.cvc-phase-column__title {
  font-size: 1.25rem;
  font-weight: 700;
  margin-bottom: 1rem;
  padding-bottom: 0.5rem;
  border-bottom: 2px solid var(--cvc-yellow);
  color: var(--cvc-green);
}

.cvc-phase-column__links {
  list-style: none;
  padding: 0;
  margin: 0;
}

.cvc-phase-column__links li {
  margin-bottom: 0.5rem;
}

.cvc-phase-column__links a {
  display: block;
  padding: 0.5rem;
  text-decoration: none;
  color: #6a6a6a;
  border-radius: 4px;
  transition: all 0.2s ease;
}

.cvc-phase-column__links a:hover {
  background: color-mix(in oklab, var(--cvc-yellow) 10%, transparent 90%);
  color: var(--cvc-green);
  padding-left: 0.75rem;
}

/* Product Filtering */
.filtered-out {
  display: none !important;
}

#current-van-model-display {
  display: none;
  padding: 0.5rem 1rem;
  background: #e6f2ff;
  color: #0066cc;
  border-radius: 4px;
  font-size: 0.9rem;
  font-weight: 600;
  text-transform: capitalize;
}

/* Responsive Styles */
@media (max-width: 768px) {
  .van-selector {
    flex-direction: column;
    align-items: stretch;
  }

  .van-selector__dropdown {
    max-width: 100%;
  }

  .cvc-megamenu__content--two-column {
    grid-template-columns: 1fr;
    gap: 2rem;
  }

  .cvc-megamenu__images {
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
  }

  .cvc-megamenu__text-links {
    grid-template-columns: 1fr;
  }

  .cvc-megamenu__phases {
    grid-template-columns: 1fr;
  }

  .cvc-start-build__features {
    grid-template-columns: 1fr;
  }

  .cvc-megamenu {
    padding: 1rem;
  }

  .cvc-megamenu__title {
    font-size: 1.5rem;
  }
}

/* Accessibility */
.cvc-van-model-link:focus,
.cvc-phase-column__links a:focus,
.cvc-start-build__button:focus,
.cvc-feature-card__link:focus {
  outline: 2px solid #0066cc;
  outline-offset: 2px;
}

@media (prefers-reduced-motion: reduce) {
  .cvc-van-model-link--image,
  .cvc-start-build__button,
  .cvc-feature-card {
    transition: none;
  }
}
</style>

<script>
/**
 * CVC Van Selector
 * Manages van model selection and product filtering across the site
 */
(function() {
  'use strict';

  const SESSION_KEY = 'selectedVanModel';
  const ACTIVE_CLASS = 'active';
  
  /**
   * Van Selector Manager
   */
  class VanSelectorManager {
    constructor() {
      this.selectedModel = this.getSelectedModel();
      this.init();
    }

    init() {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => this.setup());
      } else {
        this.setup();
      }
    }

    setup() {
      this.syncFromURL();
      this.setupDropdown();
      this.setupVanModelLinks();
      this.updateUIState();
      this.applyFiltersToPage();
    }
    
    syncFromURL() {
      // Check if URL has a filter.p.tag parameter
      const urlParams = new URLSearchParams(window.location.search);
      const urlFilter = urlParams.get('filter.p.tag');
      
      if (urlFilter) {
        // Sync URL filter to sessionStorage
        this.setSelectedModel(urlFilter);
        console.log('Synced filter from URL:', urlFilter);
      }
    }

    getSelectedModel() {
      try {
        return sessionStorage.getItem(SESSION_KEY);
      } catch (e) {
        console.warn('sessionStorage not available:', e);
        return null;
      }
    }

    setSelectedModel(modelId) {
      try {
        if (modelId) {
          sessionStorage.setItem(SESSION_KEY, modelId);
          this.selectedModel = modelId;
        } else {
          sessionStorage.removeItem(SESSION_KEY);
          this.selectedModel = null;
        }
      } catch (e) {
        console.warn('Could not save to sessionStorage:', e);
      }
    }

    nameToSlug(name) {
      return 'model-' + name.toLowerCase().replace(/\s+/g, '-');
    }

    setupDropdown() {
      const dropdown = document.getElementById('van-select');
      const clearButton = document.getElementById('clear-van-selection');

      if (dropdown) {
        if (this.selectedModel) {
          dropdown.value = this.selectedModel;
        }

        dropdown.addEventListener('change', (e) => {
          const newSelection = e.target.value;
          this.handleModelSelection(newSelection);
        });
      }

      if (clearButton) {
        clearButton.addEventListener('click', () => {
          this.clearSelection();
        });
      }
    }

    setupVanModelLinks() {
      const links = document.querySelectorAll('.cvc-van-model-link--image');
      
      links.forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const modelId = link.getAttribute('data-model-id');
          const modelName = link.getAttribute('data-model-name');
          
          if (modelId) {
            this.handleModelSelection(modelId, modelName);
          }
        });
      });
    }

    handleModelSelection(modelId, modelName = null) {
      if (!modelId) {
        this.clearSelection();
        return;
      }

      this.setSelectedModel(modelId);
      this.updateUIState();
      
      // Check if we're on a collection or product page
      if (this.isCollectionOrProductPage()) {
        // Update URL and reload to apply filter
        this.updateURLAndReload(modelId);
      } else {
        // On other pages, just apply filters without reload
        this.applyFiltersToPage();
        this.showNotification(`Van model set to: ${modelName || modelId}`);
      }
    }
    
    isCollectionOrProductPage() {
      const pathname = window.location.pathname;
      return pathname.includes('/collections/') || pathname.includes('/products/');
    }
    
    updateURLAndReload(modelId) {
      const url = new URL(window.location.href);
      
      // Remove any existing filter.p.tag parameters
      const params = new URLSearchParams(url.search);
      for (const key of Array.from(params.keys())) {
        if (key.startsWith('filter.p.tag')) {
          params.delete(key);
        }
      }
      
      // Add the new filter parameter
      params.set('filter.p.tag', modelId);
      
      // Update the URL
      url.search = params.toString();
      
      // Navigate to the filtered URL
      window.location.href = url.toString();
    }

    clearSelection() {
      this.setSelectedModel(null);
      
      // If on collection or product page, reload to clear filter
      if (this.isCollectionOrProductPage()) {
        const url = new URL(window.location.href);
        const params = new URLSearchParams(url.search);
        
        // Remove all filter.p.tag parameters
        for (const key of Array.from(params.keys())) {
          if (key.startsWith('filter.p.tag')) {
            params.delete(key);
          }
        }
        
        url.search = params.toString();
        window.location.href = url.toString();
      } else {
        // On other pages, just update UI and apply filters
        this.updateUIState();
        this.applyFiltersToPage();
        this.showNotification('Van model filter cleared');
      }
    }

    updateUIState() {
      const dropdown = document.getElementById('van-select');
      if (dropdown) {
        dropdown.value = this.selectedModel || '';
      }

      const clearButton = document.getElementById('clear-van-selection');
      if (clearButton) {
        clearButton.style.display = this.selectedModel ? 'block' : 'none';
      }

      const links = document.querySelectorAll('.cvc-van-model-link--image');
      links.forEach(link => {
        const modelId = link.getAttribute('data-model-id');
        if (modelId === this.selectedModel) {
          link.classList.add(ACTIVE_CLASS);
        } else {
          link.classList.remove(ACTIVE_CLASS);
        }
      });

      this.updateHeaderDisplay();
    }

    updateHeaderDisplay() {
      const displayElement = document.getElementById('current-van-model-display');
      if (displayElement) {
        if (this.selectedModel) {
          const modelName = this.selectedModel.replace('model-', '').replace(/-/g, ' ');
          displayElement.textContent = `Showing: ${modelName}`;
          displayElement.style.display = 'block';
        } else {
          displayElement.style.display = 'none';
        }
      }
    }

    applyFiltersToPage() {
      this.filterProducts();
      this.modifySearchForms();
      this.modifyCollectionLinks();
    }

    filterProducts() {
      const products = document.querySelectorAll('[data-product-models]');
      
      products.forEach(product => {
        const productModels = product.getAttribute('data-product-models');
        
        if (!this.selectedModel) {
          product.style.display = '';
          product.classList.remove('filtered-out');
        } else {
          const hasModelTags = productModels && productModels.trim() !== '';
          
          if (!hasModelTags) {
            product.style.display = '';
            product.classList.remove('filtered-out');
          } else {
            const models = productModels.split(' ').filter(m => m.trim() !== '');
            const hasModelUniversal = models.includes('model-universal');
            const hasMatchingModel = models.includes(this.selectedModel);
            const hasNoModelTags = models.every(tag => !tag.startsWith('model-'));
            
            if (hasMatchingModel || hasModelUniversal || hasNoModelTags) {
              product.style.display = '';
              product.classList.remove('filtered-out');
            } else {
              product.style.display = 'none';
              product.classList.add('filtered-out');
            }
          }
        }
      });
    }

    modifySearchForms() {
      const searchForms = document.querySelectorAll('form[action*="/search"]');
      
      searchForms.forEach(form => {
        form.removeEventListener('submit', this.handleSearchSubmit);
        
        if (this.selectedModel) {
          form.addEventListener('submit', this.handleSearchSubmit.bind(this));
        }
      });
    }

    handleSearchSubmit(e) {
      e.preventDefault();
      
      const form = e.target;
      const searchInput = form.querySelector('input[name="q"]');
      const existingQuery = searchInput ? searchInput.value : '';
      
      const newQuery = existingQuery 
        ? `${existingQuery} AND tag:${this.selectedModel}`
        : `tag:${this.selectedModel}`;
      
      window.location.href = `/search?q=${encodeURIComponent(newQuery)}`;
    }

    modifyCollectionLinks() {
      const collectionLinks = document.querySelectorAll('a[href*="/collections/"]');
      
      collectionLinks.forEach(link => {
        // Skip van model selector links - they have their own handler
        if (link.classList.contains('cvc-van-model-link--image') || 
            link.classList.contains('cvc-van-model-link--text')) {
          return;
        }
        
        if (!link.hasAttribute('data-original-href')) {
          link.setAttribute('data-original-href', link.href);
        }
        
        const originalHref = link.getAttribute('data-original-href');
        
        if (this.selectedModel) {
          // Parse the URL to properly add the filter parameter
          let url;
          try {
            url = new URL(originalHref, window.location.origin);
          } catch (e) {
            // If URL parsing fails, use simple string concatenation
            const separator = originalHref.includes('?') ? '&' : '?';
            link.href = `${originalHref}${separator}filter.p.tag=${this.selectedModel}`;
            return;
          }
          
          // Remove any existing filter.p.tag parameters
          const params = new URLSearchParams(url.search);
          for (const key of Array.from(params.keys())) {
            if (key.startsWith('filter.p.tag')) {
              params.delete(key);
            }
          }
          
          // Add the new filter parameter
          params.set('filter.p.tag', this.selectedModel);
          url.search = params.toString();
          
          link.href = url.toString();
        } else {
          link.href = originalHref;
        }
      });
    }

    showNotification(message) {
      const notification = document.getElementById('van-selector-notification');
      const notificationTitle = document.getElementById('van-notification-title');
      const notificationText = document.getElementById('van-notification-message');
      const backdrop = document.getElementById('van-notification-backdrop');
      
      if (!notification || !notificationTitle || !notificationText) {
        console.warn('Van notification elements not found');
        return;
      }

      // Clear any existing timeouts
      if (notification._hideTimeout) {
        clearTimeout(notification._hideTimeout);
        notification._hideTimeout = null;
      }
      if (notification._showTimeout) {
        clearTimeout(notification._showTimeout);
        notification._showTimeout = null;
      }

      // Set the message as title (for compatibility with old code)
      notificationTitle.textContent = message;
      notificationText.textContent = '';

      // Reset animation
      notification.setAttribute('data-showing', 'false');
      if (backdrop) backdrop.setAttribute('data-showing', 'false');

      // Show with animation
      notification._showTimeout = setTimeout(() => {
        notification.setAttribute('data-showing', 'true');
        if (backdrop) backdrop.setAttribute('data-showing', 'true');

        // Function to hide notification
        const hideNotification = () => {
          notification.setAttribute('data-showing', 'false');
          if (backdrop) backdrop.setAttribute('data-showing', 'false');
          
          // Remove click handlers
          if (backdrop) backdrop.removeEventListener('click', hideNotification);
          notification.removeEventListener('click', hideNotification);
          
          // Clear timeout
          if (notification._hideTimeout) {
            clearTimeout(notification._hideTimeout);
            notification._hideTimeout = null;
          }
        };

        // Add click handlers to close on click
        if (backdrop) backdrop.addEventListener('click', hideNotification);
        notification.addEventListener('click', hideNotification);

        // Hide after 6 seconds
        notification._hideTimeout = setTimeout(hideNotification, 6000);
      }, 50);
    }
  }

  const vanSelector = new VanSelectorManager();
  window.VanSelector = vanSelector;

})();
</script>
