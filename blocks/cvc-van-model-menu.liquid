{% comment %}
  Van Model Megamenu Block
  This is designed to be used as a block within a header section
  
  Usage in section schema:
  {
    "type": "van_model_megamenu",
    "name": "Van Model Megamenu",
    "settings": [...]
  }
{% endcomment %}

<div class="cvc-megamenu cvc-megamenu--van-models" data-notification-message="{{ block.settings.notification_message | default: 'We will only show you products that are for your van' }}">
  <div class="cvc-megamenu__container">

    <div class="cvc-megamenu__content cvc-megamenu__content--two-column">
      {%- comment -%} Left Column - Image Links {%- endcomment -%}
      <div class="cvc-megamenu__images">
        {% for van_block in section.blocks %}
          {% if van_block.type == 'van_model' %}
            {% assign model_name = van_block.settings.van_name %}
            {% assign display_name = van_block.settings.van_display_name | default: model_name %}
            {% assign model_image = van_block.settings.van_image %}
            
            {% if model_name != blank %}
              {% liquid
                assign model_slug = model_name | handleize | prepend: 'model-'
              %}
              <a
                href="#"
                class="cvc-van-model-link cvc-van-model-link--image"
                data-model-id="{{ model_slug }}"
                data-model-name="{{ model_name }}"
                data-display-name="{{ display_name }}"
                {{ van_block.shopify_attributes }}
              >
                {% if model_image %}
                  <img
                    src="{{ model_image | image_url: width: 200 }}"
                    alt="{{ display_name }}"
                    loading="lazy"
                    width="200"
                    height="auto"
                  >
                {% else %}
                  <div class="cvc-van-model-link__placeholder">
                    <span>{{ display_name }}</span>
                  </div>
                {% endif %}
                <span class="cvc-van-model-link__label">{{ display_name }}</span>
              </a>
            {% endif %}
          {% endif %}
        {% endfor %}
      </div>

      {%- comment -%} Right Column - Shop Menu Links {%- endcomment -%}
      <div class="cvc-megamenu__text-links">
        {% for link in linklists.header-menu.links %}
          {% if link.title == 'Shop' %}
            {% if link.links.size > 0 %}
              {% for child_link in link.links %}
                <a
                  href="{{ child_link.url }}"
                  class="cvc-van-model-link cvc-van-model-link--text"
                >
                  {{ child_link.title }}
                </a>
              {% endfor %}
            {% endif %}
          {% endif %}
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<script>
  // Handle van model selection
  (function() {
    const vanModelLinks = document.querySelectorAll('.cvc-van-model-link--image');
    console.log('Found van model links:', vanModelLinks.length);
    
    /**
     * Check if we're on a collection or product page
     */
    function isCollectionOrProductPage() {
      const pathname = window.location.pathname;
      return pathname.includes('/collections/') || pathname.includes('/products/');
    }
    
    /**
     * Update URL with filter parameter and optionally reload
     * @param {string} modelId - The model slug
     * @param {string} modelName - The exact metafield value to filter by
     */
    function updateURLWithFilter(modelId, modelName) {
      const url = new URL(window.location.href);
      
      // Remove any existing Van Model filter parameters
      const params = new URLSearchParams(url.search);
      for (const key of Array.from(params.keys())) {
        if (key.startsWith('filter.p.m.custom.van_model') || key.startsWith('filter.p.tag')) {
          params.delete(key);
        }
      }
      
      // Add the new metafield filter parameter (use exact modelName value)
      params.set('filter.p.m.custom.van_model', modelName);
      
      // Update the URL
      url.search = params.toString();
      
      return url;
    }
    
    /**
     * Apply filter to current page or navigate
     * @param {string} modelId - The model slug
     * @param {string} displayName - The display name for UI messages
     * @param {string} modelName - The exact metafield value to filter by
     */
    function applyFilterToPage(modelId, displayName, modelName) {
      // If on collection or product page, update URL and reload to apply filter
      if (isCollectionOrProductPage()) {
        const newUrl = updateURLWithFilter(modelId, modelName);
        console.log('Navigating to filtered URL:', newUrl.toString());
        window.location.href = newUrl.toString();
      } else {
        // On other pages, just show a notification (use displayName for UI)
        showNotification(`Van filter set to: ${displayName}. Navigate to a collection to see filtered products.`);
      }
    }
    
    /**
     * Show notification to user
     */
    function showNotification(message) {
      const notification = document.getElementById('van-selector-notification');
      const notificationText = document.getElementById('van-notification-message');
      
      if (!notification || !notificationText) {
        console.warn('Notification element not found');
        return;
      }

      // Clear any existing timeouts stored globally on the notification element
      if (notification._hideTimeout) {
        clearTimeout(notification._hideTimeout);
        notification._hideTimeout = null;
      }
      if (notification._showTimeout) {
        clearTimeout(notification._showTimeout);
        notification._showTimeout = null;
      }

      // Get custom message from megamenu settings
      const megamenu = document.querySelector('.cvc-megamenu--van-models');
      const customMessage = megamenu ? megamenu.getAttribute('data-notification-message') : null;
      
      // Use custom message if available, otherwise use default
      notificationText.textContent = customMessage || 'We will only show you products that are for your van';
      
      // Reset animation by setting to false first
      notification.setAttribute('data-showing', 'false');
      
      // Use a small timeout to ensure the reset is processed
      notification._showTimeout = setTimeout(() => {
        // Show notification with bounce animation
        notification.setAttribute('data-showing', 'true');

        // Hide after 6 seconds (2x the original 3 seconds)
        notification._hideTimeout = setTimeout(() => {
          notification.setAttribute('data-showing', 'false');
        }, 6000);
      }, 50);
    }
    
    vanModelLinks.forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();
        
        const modelId = this.getAttribute('data-model-id');
        const modelName = this.getAttribute('data-model-name');
        const displayName = this.getAttribute('data-display-name') || modelName;
        
        console.log('Van model link clicked:', { modelId, modelName, displayName });
        
        if (modelId) {
          // Store the selected van model
          sessionStorage.setItem('selectedVanModel', modelId);
          console.log('Stored in sessionStorage:', modelId);
          
          // Remove active class from all links
          vanModelLinks.forEach(l => l.classList.remove('active'));
          
          // Add active class to clicked link
          this.classList.add('active');
          
          // Dispatch custom event
          const event = new CustomEvent('vanModelSelected', {
            detail: { modelId, modelName, displayName },
            bubbles: true
          });
          document.dispatchEvent(event);
          
          console.log('Dispatched vanModelSelected event for:', displayName);
          
          // Apply filter to current page (displayName for UI, modelName for filtering)
          applyFilterToPage(modelId, displayName, modelName);
        } else {
          console.warn('No modelId found on clicked link');
        }
      });
    });
    
    // On page load, highlight the currently selected van
    const selectedModelId = sessionStorage.getItem('selectedVanModel');
    if (selectedModelId) {
      console.log('Page loaded with selected van:', selectedModelId);
      const selectedLink = document.querySelector(`.cvc-van-model-link--image[data-model-id="${selectedModelId}"]`);
      if (selectedLink) {
        selectedLink.classList.add('active');
        console.log('Added active class to existing selection');
      }
    }
  })();
</script>

{% schema %}
{
  "name": "Van Model Megamenu",
  "settings": [
    {
      "type": "header",
      "content": "Van Models Configuration"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "Products"
    },
    {
      "type": "text",
      "id": "notification_message",
      "label": "Chosen Van Model Message",
      "default": "We will only show you products that are for your van",
      "info": "Message displayed when a user selects their van model"
    },
    {
      "type": "paragraph",
      "content": "To add van models: 1) Click 'Add block' at the section level, 2) Select 'Van Model', 3) Configure the van name and image. The van models will appear in this megamenu automatically."
    }
  ]
}
{% endschema %}
